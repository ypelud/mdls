$(document).ready(function() {
	$('#alert').hide();
	$('#alert').show('highlight', {} , 1000, function() { 
			setTimeout(function() {
				$('#alert').removeAttr( "style" ).fadeOut();
			}, 1000)});
	
	
	$('.menu_cart').draggable({ revert: true, helper: "clone" });
	
	$('.cart_drop').droppable({
		    accept:'.menu_cart', 
		    hoverclass:'cart-active',
				drop: function( event, ui ) {
					var dc = $(this)
					var url = dc.attr("data-url")+"&id="+$(ui.draggable).attr("id");
					$.ajax({
					  url: url,
					}).done(function(data) { 
					  dc.html(data)
					});
				}
			});

	$(this).delegate(".rm_cart", "click", function() {
			var url = $(this).attr("href");
			var dc = $(this).parents(".cart_drop");
			$.ajax({
			  url: url,
			}).done(function(data) { 
			  dc.html(data)
			});
			return false;
	});
	
	$(this).delegate(".login_ref", "click", function() {
			$("#login_div").show('blind');
			return false;
	});
	
	$(this).delegate(".lnk_comment", "click", function() {
			var url = $(this).attr("href");
			$.ajax({
			  url: url,
			}).done(function(data) { 
				var cd = $("#comment_div");
			  cd.html(data);
			  cd.show('blind');
			});
			return false;
	});
	
	$(this).delegate("#commit_comment", "click", function() {
		var form = $(this).parents("form")
		var url = form.attr("action");
		$.ajax({
		  url: url,
		  data: form.serialize()
		}).done(function(data) { 
			var cd = $("#comment_div");
		  cd.hide("blind")
		  cd.html(data);
		  cd.show("blind")
		});
		return false;
	});
	
	function replaceAfterLastSlash( ref, str) {
		ref.each( function() {
			var url = $(this).attr("href");
			var end = url.match("[^?]+$");

			var reg=new RegExp("[^/]+$", "g");
			var url2 = url.replace(reg, str);
			$(this).attr("href", url2 + "?" + end);
			
		});
		
	}
	
	$(this).delegate(".mnu", "mouseenter", function() {
		$(this).addClass("actif");
		$(this).append( $("#mnu_bar").show());
		replaceAfterLastSlash($("#mnu_bar > .del"), $(this).attr("id") ) ;
		replaceAfterLastSlash($("#mnu_bar > .add"), $(this).attr("id") ) ;
	});

	$(this).delegate(".mnu", "mouseleave", function() {
		$(this).removeClass("actif");
		$("#mnu_bar").hide();
	});
	
	$(this).delegate("#mnu_bar > .add", "click", function() {
		var url = $(this).attr("href");
		var idx = $(this).attr("id");
		$.ajax({
		  url: url,
		}).done(function(data) { 
			var cd = $("#cart_"+idx+" > .cart_drop");
		  cd.html(data);
		});
		return false;
	});
	
})